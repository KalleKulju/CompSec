Computer Security Lab 3: Malware and botnets - insight for maliciousness 
====


## Preliminary tasks

It is recommended to read at least following articles in some level to get familiar about topic.

### For first and second task

What are [macros in Office documents, why they could pose a thread?](https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/macro-malware)



### For third task these could give some insight about the purpose ofd

[What is a DDoS attack?](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/)

[Botnets?](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-botnet/)


### For the last task:

Blog post about malware analysis [in here.](https://medium.com/@dunstconsulting/the-different-types-of-malware-analysis-c9bfbaa44739)

[What is sandbox?](https://www.quora.com/In-computer-security-what-is-a-sandbox)

If you are not familiar with Wireshark, take brief look in to it. [Here is short tutorial.](https://www.lifewire.com/wireshark-tutorial-4143298)

About memory analysis with Volatility: [here](https://medium.com/@zemelusa/first-steps-to-volatile-memory-analysis-dcbd4d2d56a1) is some good blog post about it. This is automated in task 1, but volatility can be used externally as well for taken memory dump. 

## Background

Malicious programs are potential harm for almost every user in the internet. Right at this moment (and in the past), one is especially causing gray hairs for plenty of people; *Emotet* malware.  Finnish National Cyber Security Centre (NCSC-FI) just released (8/2020)  [yellow level of warning](https://www.kyberturvallisuuskeskus.fi/en/emotet-malware-actively-spread-finland) about malware; how big is the risk for facing this malware be at the moment.

There are many was for malware to spread. This one is using old, but still working tactic: email attachments. Innocent looking attachment in the innocent looking email message could contain something what you did not except. This particular malware is known mostly as *information stealer*. It installs trojan horse on computer, and is able to receive almost arbitrary commands for making actions for infected computer.


This exercise is based on real-life incident, which happened some time ago in Finland. One service was target of distributed denial-of-service (DDoS), and was periodically taken down by it.

The attacker had deployed botnet to perform DDoS attack to targeted service. Botnet was created by malicious software, spread by various methods.

The malware which was used to create botnet, had some flaws and some simple weakness was exploited in targeted service, which gives us a good example for researching.

We will take a look for *very* simple implementation for botnet in demonstration purposes.

Further, we will analyze the software, which was used for creating botnet, by using dynamic and static analysis method.

In the last task of the exercise, there is possibility to analyze another common malware, *WannaCry* which is infamous ransomware and caused some chaos some years ago.

(Part of this real-life DDoS incident can be seen in the Lab 6 (Digital Forensics) as well, in [Task 3](../Lab6_Digital_Forensics/README.md#Task-3). In that exercise you can see what kind of traces DDoS attack can leave in log files. You will learn  how to analyze large-sized log file, and made precises analysis from it. )

---
Grading
---
Make a short step-by-step report (what, why and how) of following tasks, and include possible source codes and the most important command line commands used in those tasks. It's recommended to read all tasks before starting. Actual instruction for what to do, is ***in bold and italics*** on each task.

You are eligible to following grades in this exercise by doing tasks as defined. Great ideas and implementations could compensate some poorly implemented ones.
*Upper grade requires that all previous tasks have been done as well.*

It is estimated, that you are able to do Task 1 and 2 during lab session (4 hours).

Tasks 3 & 4 are more advanced than earlier ones. Implementation will very likely take time outside of lab.

Task|Grade/Level|Description|
----|:---:|-----------|
[Task 1](#task-1--identifying-malicious-documents "Identifying malicious documents") | 1 | Malware: dynamic analysis
[Task 2](#task-3-malware---static-analysis "Malware - static analysis") | 4 | Malware: static analysis
[Task 3](#task-4 "Analysis for more complicated samples ") | 5 | Analysis for more complicated samples OR making own analysis tool

Grade 1 can be acquired by doing lecture questionnaires from the corresponding lectures.


Grade 2 (bare minimum from the lab) can be acquired by doing Task  1.

Difficulty on tasks is expected to be raising as you go forward with them.

You should read all of the instructions, that you know what is happening, and what you actually have to do.

*Return completed tasks to your private GitHub repository!
There will be answer template or more instructions.*

---



## **Task 1: Identifying malicious documents**

We have a bunch of document files, whereas some of them are really suspicious ones. Without opening them (hopefully), could we identify the malicious ones from the clean ones?

There are various amount of tools for doing that for you, and we are going to try out some them.

**WARNING:** Do not extract the zip files in Windows machine. Antivirus might flag them, even though there are not really malicious files. They just look like.


Tools for analysing PDF files. They attempt to identify some known patters, which usually can be seen in malicious file, and rarely in clean files.

 * peepdf & 
 * pdfid
 * jsunpack-n
 * 

A) What is the worst thing you can do with suspicious Microsoft Office document? What is disabled by default, when you open the document?

B) Malicious pdf files are not that common. What could be the reason? How they are usually infecting the machine of potential victim?


## Task 2

Email messages are based on [RFC 822 standard](https://www.ietf.org/rfc/rfc0822.txt).

## **Task 2: Malware - static analysis**


Previously we have performed dynamic analysis for malware: inspecting the behavior of the malware by executing it.

Another way for analysing is to perform static analysis - we are not executing the malware, instead we are looking at the file(s) itself.

At first glance, if we haven't got much experience about reverse engineering, we might be seeing just some .exe files, and have no idea how to start.

But with some correct tools, we might see a lot, *particularly* in this case!

Let's see what basic Linux command *file* has to say:

```shell
$ file SteamCodeGenerator2016.exe
SteamCodeGenerator2016.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows
```

Looks like that we are probably facing .Net assembly.

One good tool for reversing these kind of executables is [dnSpy.](https://github.com/0xd4d/dnSpy), and we are using it as an example in this case. You should download it.

*NOTE: Download release zip of NET Framework 4.7.2  version! Not direct source.*, 

It is portable tool, which is fully working assembly editor on Windows environment.
In Linux, we can use some of the properties of it, like console part.
We can decompile executables with it, which is enough for us.

Example for decompiling in Linux environment.
Go to dnSpy root directory:
```shell
mono dnSpy.Console.exe -o your/output/path path/to/your/malware.exe 
```
You will need to install [mono](https://www.mono-project.com) to your enviroment, if you want repeat it on another Linux than the one we have provided. Make sure, that you have at least Mono version 5. 

You can also use this tool in sandboxed Windows. This enables some more features and GUI usage, but those are not  mandatory.


Once we disassemble these files, we can actually see whole source code as it's written. It might take couple of minutes to decompile, depending on file, so patience is required. The biggest file might take 10 minutes or more.

Files are not protected at all.

This malware was written in Visual Basic (we can see code as C#) and looks like it has been Microsoft Visual Studio project.

**Now, the intention of this task is to write short report what program is actually doing.** Since we can read program mostly in C#, it shouldn't be hard at all. (In most cases malwares are written in C language or protected somehow, and there we might need to read pure machine instructions instead.)

There should be some exactly same things, what we tought there to be, based on dynamic analyis, if we did it right.

You are free to use any tools you want, as long as you are not analysing in your host system in unsafe environment. Even though this malware is not dangerous anymore, it's good to have principles.

**TIP:** In case .resource files (binary type) are provided instead of .resx format, you can convert it into .resx format from command line as:
  
`resgen Resource.resource Resource.resx`

[.Resx files?](https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2008/ekyft91f(v=vs.90))

>**Answer *at least* to these questions in your report:**

### A) What's the role of SteamCodeGenerator.exe, keycrack.exe and steam-dll-pro.exe?

### B) How are they trying to hide their current/upcoming activites?

### C) What's the role of anti-cheat-bypass-tool.exe in Data folder?

* We are particularly interested about this file.
* This file contains actually two additional binaries. (These files have been encoded to .resx file somehow) What are their names?
* **Find a way** to reverse these files as well, and include the general purposes of these files as well to your report. Additionally:
  * How bots were controlled? There were at least two ways, describe at least the automatic approach.
  * Some source code or ideas of some common DDoS tools have been used in this malware. Describe three of them. It's enough to identify tools, you can look information about them elsewhere.
  * Malware actually contains hidden GUI for DDoS tools it is using. Can you find and use it? Describe how you did it.

### D) How well you were able to gather information from malware with dynamic analysis when compared to full reveal from source code? (optional question, does not affect grade)

## Task 3:

Implement **one** of the described following tasks, and make step-by-step report (what,why and how) including source files, for what you did:

* Ever heard about WannaCry malware? In two years ago (2017), this malware caused a lot of troubles in hospitals and other organisations. This malware was ransomware attack, and encrypted all the important files of machine. It exploited some vulnerabilities, which gave it self-spreading properties, making it a *worm*. Luckily there was a flaw (or intended property), which was so called *kill switch*, and stopped the spreading of malware in the cases, when machine was able to connect internet. Every time when malware was executed, it looked for some domain. Based on result malware did something. 
**In this task, we will take of look for original [*dropper*](https://en.wikipedia.org/wiki/Dropper_(malware)) of WannaCry. Only this specific dropper contained so called kill-switch.**

    * **Your task is to make static analysis for this dropper, and make step-by-step report, how you can find location of domain name of kill-switch. It should not be too hard, since you know that it exists. Explain this function, which contains kill switch.**

    * Explanation contains how you found the URL and therefore the function. What is the logic of this function? How kill-switch worked?
    What other functions are called in this function? Are functions from other library?
    
    * You can use (and it is recommended to use) for example [radare2](https://github.com/radare/radare2) for reverse engineering this executable. In practice, we are disassembling binary to machine instructions, and looking the code of malware in assembly language.
    Radare2 will be used in future as well.

    * Cheatsheet for Radare2 can be found [here.](https://github.com/radare/radare2/blob/master/doc/intro.md)

    * If you have no idea how to start, you can run this malware in sandbox as well, and get URL from there. This is not necessary. *But you can do it anyway, if you want to see, what this malware is doing for machine in practice.*

    *  **Some tips**: Can you find this URL, just by looking from *strings* in malware's binary? Further, can you find, where this string is referenced?



* **Something interesting** in botnets or malwares, but we haven't dealt with it yet? Feel free to implement and show us what you got. **Your task has to be approved by assistant before you can start doing it.** Depending on estimated workload, this task could be extendable to final coursework.
