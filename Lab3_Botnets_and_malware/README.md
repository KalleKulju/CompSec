
Computer Security Lab 3: From innocent document file into part of botnet 
====



## Preliminary tasks

It is recommended to read at least following articles in some level to get familiar about topic.

### For the first and second task

What are [macros in Office documents, why they could pose a thread?](https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/macro-malware)

How about [PDF files?](https://www.decalage.info/file_formats_security/pdf)

Take a look for [SANS DFIR short guide](https://digital-forensics.sans.org/media/analyzing-malicious-document-files.pdf) for analysing malicious documents. We are using some of the tools.

Further reading about malicious PDF and Office malware is [available in here.](https://www.tandfonline.com/doi/full/10.1080/19393555.2020.1723747?scroll=top&needAccess=true) It is long but quite all-answering. (Available in the University Network (can be accessed [via VPN](https://www.oulu.fi/ict/openvpn)), but who knows if someone makes check for Sci-Hub)


### For third task these could give some insight about the purpose of the executable

[What is a DDoS attack?](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/)

[Botnets?](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-botnet/)

We will be using dotnet decompiler ([ILSpy](https://github.com/icsharpcode/ILSpy)) to see how malware works on source code level.

### For the last task:

Blog post about malware analysis [in here.](https://medium.com/@dunstconsulting/the-different-types-of-malware-analysis-c9bfbaa44739)

[What is sandbox?](https://www.quora.com/In-computer-security-what-is-a-sandbox)

If you are not familiar with Wireshark, take brief look in to it. [Here is short tutorial.](https://www.lifewire.com/wireshark-tutorial-4143298)

About memory analysis with Volatility: [here](https://medium.com/@zemelusa/first-steps-to-volatile-memory-analysis-dcbd4d2d56a1) is some good blog post about it. This is automated in the task, but volatility can be used externally as well for taken memory dump. 

## Background

Malicious programs are potential harm for almost every user in the internet. Right at this moment (and in the past), one is especially causing gray hairs for plenty of people; *Emotet* malware.  Finnish National Cyber Security Centre (NCSC-FI) just released (8/2020)  [yellow level of warning](https://www.kyberturvallisuuskeskus.fi/en/emotet-malware-actively-spread-finland) about malware; how big is the risk for facing this malware to be at the moment on organizations. Maybe COVID-19 pandemic made botnet operators to give up on their vacation, and they are pushing new variations of the old malware. 

There are many ways for malware to spread. This one is using as one, old but still working tactic where user is involved: email attachments. Innocent looking attachment in the innocent looking email message could contain something what you did not except. The content of the attachment is usually made to be something, what you might be more compelling to open: invoices, receipts, legal documents, and more. *In 2017, according to Cisco, 38% of malicious file distributors belonged to Office suite file extensions and 14% containing PDF extension. [[1]](https://www.tandfonline.com/doi/full/10.1080/19393555.2020.1723747?scroll=top&needAccess=true).*

*Emotet* is currently known mostly as *information stealer*. It is [RAT](https://www.howtogeek.com/410634/what-is-rat-malware-and-why-is-it-so-dangerous/) (Remote Access Trojan) on the computer, and is able to receive almost arbitrary commands for making actions for infected computer.

This exercise is mostly based on something similar. Malicious document file is doing something more in your computer than you thought! *However, files here are not dangerous, but they can be flagged by some anti-virus products. It is recommended to handle them in Linux based operating system!* **With one exception; the malware of final task (WannaCry) is ransomware and it should not be executed in on old Windows machine! Even better, don't get it into your Windows host machine.**

In the first task, we try to identify whether PDF of Office document file is clean or malicious, and further try to analyze what suspicious they are doing slightly.

In the second task, we will take a look for *.eml* file (Saved email message), and try to analyze it's attachment. How far we can go?

In the third task, we are analysing something that attachment in previous task attempts to download and install. This executable is part of the real-life incident, which was used to deploy botnet network for performing DDoS attack against official Finnish government websites and other targets. Malware was originally distributed as trojan horse, a Steam Code Generation application which was supposed to give you free steam codes. (What it of course did not do)

In the last task of the exercise, there is possibility to analyze another common malware, *WannaCry* which is infamous ransomware and caused some chaos some years ago. It had worm-like properties by exploiting some vulnerabilities and spreading mostly without user involvement.

(Part of this real-life DDoS incident can be seen in the Lab 6 (Digital Forensics) as well, in [Task 3](../Lab6_Digital_Forensics/README.md#Task-3). In that exercise you can see what kind of traces DDoS attack can leave in log files. You will learn  how to analyze large-sized log file, and made precises analysis from it. )

---
Grading
---
Make a short step-by-step report (what, why and how) of following tasks, and include possible source codes and the most important command line commands used in those tasks. It's recommended to read all tasks before starting. Actual instruction for what to do, is ***in bold and italics*** on each task.

You are eligible to following grades in this exercise by doing tasks as defined. Great ideas and implementations could compensate some poorly implemented ones.
*Upper grade requires that all previous tasks have been done as well.*

It is estimated, that you are able to do Task 1 and 2 during lab session (4 hours).

Tasks 3 & 4 are more advanced than earlier ones. Implementation will very likely take time outside of lab.

Task|Grade/Level|Description|
----|:---:|-----------|
[Task 1](#task-1--identifying-malicious-documents "Identifying malicious documents") | 1 | Identifying malicious documents
[Task 2](#task-2-malware---static-analysis "Deeper analysis of Office Document") | 2-3 | Deeper analysis of Office Document
[Task 3](#task-3-static-analysis-of-trojan "Static analysis of trojan") | 4 | Static analysis of trojan
[Task 4](#task-4 "Dynamic & static analysis for more complicated sample ") | 5 | Dynamic & static analysis for more complicated sample

Grade 1 can be acquired by doing the first task.

Grade 2 and 3 can be acquired by doing Task 3, depending on how far you go.

Difficulty on tasks is expected to be raising as you go forward with them.

You should read all of the instructions, that you know what is happening, and what you actually have to do.

*Return completed tasks to your private GitHub repository!
There will be answer template.*

---



## **Task 1: Identifying malicious documents**

We have a bunch of document files, whereas some of them might be something more than just documents. Without opening them (hopefully), could we identify the malicious ones from the clean ones?

One great paper about PDF and Office malware on general level is [available in here.](https://www.tandfonline.com/doi/full/10.1080/19393555.2020.1723747?scroll=top&needAccess=true)
Only available in the University Network (can be accessed [via VPN](https://www.oulu.fi/ict/openvpn)), but who knows if someone makes check for Sci-Hub.

There are various amount of tools for doing analysis partially for you, and we are going to try out some them.

Document files can be found from the zip file in [misc/malware](misc/malware) named **maldocs_task1.zip**. Password is *infected*

**WARNING:** Do not extract the zip files directly in Windows machine. Antivirus might flag and remove them, even though there are not really malicious files. They just look like and include some patterns malicious files could have.

**A) Has it been identified already?**

When we face a suspicious file, what could we do at first? The first thing we can do, is to see *if someone has already wondered the same thing and has done the analysis already!*

Many anti-virus tools and other databases are signature based - they might have exact [signature hash](https://medium.com/@tom_rock/fifty-shades-of-malware-hashing-3783d98df59c) or some other regular pattern database for detecting malware. Someone/something might have submitted the file into these places and classified it.

Some tools/utilities for general analysis; does it exist already?

 * [ClamAV](https://www.clamav.net/) - The biggest Open Source antivirus engine
 * [VirusTotal](https://www.virustotal.com/gui/) - analyze url, file or search by hashes against many AV engines. CLI is available in [here.](https://github.com/VirusTotal/vt-cli)
 * [Windows Defender](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-antivirus/microsoft-defender-antivirus-in-windows-10) - many times underrated - but has possibly the largest signature and pattern based database among all Windows running anti-virus engines. Not used here in practice- but should be noted as good one because of that. (Even [scary good at collecting samples](https://medium.com/sensorfu/how-my-application-ran-away-and-called-home-from-redmond-de7af081100d))

We could try to use ClamAV once it is available:

```
clamscan <FILENAME>
```

Or with [cincan-command](https://gitlab.com/CinCan/cincan-command):

```
 cincan run cincan/clamav <FILENAME>
```
This will scan the file against ClamAV:s current database.


We could also try to use VirusTotal for seeing if there is some report about some of our file(s). We could use the graphical Web interface for that, or CLI tool. 

*We should calculate the hash (SHA256) of the file and search based on that at first - in general, uploading is quite permanent thing and then the file is identified by everyone.*
By searching with file hash, we see if the file has been already submitted in there.

`sha256sum` command can be used for calculating SHA256 hash of the file.



Do we find some malicious files based on these? Even if there are malicious files, why might not they appear there? What is the bad thing on signature based identification?

B) **What is the worst thing you can do with suspicious Microsoft Office document? (Disabled by default)**

C) **Malicious PDF files are also common. How they are usually infecting the machine of potential victim?**

D) Let's take a deeper look

Tools for analysing PDF files. They attempt to identify some known patters, which usually can be seen in malicious file, and rarely in clean files. They are easiest to use with `cincan-command` but you can install them by yourself. They are also as normal packages in Kali.

 * [pdfid](https://blog.didierstevens.com/programs/pdf-tools)
 * [pdf-parser](https://blog.didierstevens.com/programs/pdf-tools/)

At first, ideally we want to find some suspicious keywords from PDFs such as `/JavaScript`, `/OpenAction`, `/GoTo`, `/URI` and `/RichMedia`,. 

Pdf-parser and pdfid are capable for doing that. See `--help` of each tool for creating correct command. Pdf-parser can print each section of the PDF file.

E.g. pdfid is simple to use at basic level:
```
cincan run cincan/pdfid <FILENAME>
```
One of the PDF files is 'malicious'. What it attempts to do, is not working in the most PDF readers anymore.


Tools for analysing Microsoft Office documents which are using OLE2 file format. (called also as [Compound File Binary Format](https://en.wikipedia.org/wiki/Compound_File_Binary_Format) ) Usually these file ends with file extensions '.doc' or '.xls'

 * [oletools](https://github.com/decalage2/oletools) (set of different tools)
 * [oledump](https://blog.didierstevens.com/programs/oledump-py/)

 For example, the tool `olevba` from oletools can be used for analysing VBA macros from the document, and detecting some suspicious keywords:

```
cincan run cincan/oletoos olevba <FILENAME>
.
.
.
.
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |AutoOpen            |Runs when the Word document is opened        |
|Suspicious|powershell          |May run PowerShell commands                  |
|Suspicious|EncodedCommand      |May run PowerShell commands                  |
|Suspicious|Base64 Strings      |Base64-encoded strings were detected, may be |
|          |                    |used to obfuscate strings (option --decode to|
|          |                    |see all)                                     |
|IOC       |calc.exe            |Executable file name                         |
|IOC       |wonderful.ps1       |Executable file name                         |
+----------+--------------------+---------------------------------------------+
```

One of the `.doc` files is 'malicious'.


**Which files might seem to do something abnormal? What they attempt to do in general level? Are they executing some code? Include code. Include also the suspicious keywords of PDF.**

It should be noted, that these are not sophisticated malware, just demonstrating basic actions; you can never fully trust the tools.

## Task 2


Email messages are based on [RFC 822 standard](https://www.ietf.org/rfc/rfc0822.txt).

